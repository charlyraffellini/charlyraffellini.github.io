---
layout: post
title: Authentication in Azure Storage REST API
description: Producing authorization token for Azure Storage REST API
date: 2018-03-28
categories: authentication authorization saas azure storage rest microsoft api
img: 2018/authentication_azure_storage_rest_api.jpg
author: Carlos Raffellini
---


# This post is all about producing a token to call Azure Queue Storage REST API

You will find different authentication schemes depending on the API version we find in the documentation. Also, I find the documentation okay after reading it a few times but not straightforward to quickly run an example that shows how it works.

For this article, I will use `Shared Key` authentication scheme.

The authentication token is generated by a SHA256 hash function. It uses either the primary or the secondary key of your Azure Storage Account.

## Pre-conditions

- An Azure Storage Account.
- Primary or Secondary Key of your Storage Account.
- The HTTP Verb you use when you call the Azure Storage REST API.


## Actions - Produce an authorization token.

This step will use the primary key ad-hoc. You can obtain the primary key in many different ways. Here I hardcoded it in the code snippet.

There are a few important parts here:

- `signature_message` is the message of the signature we will use to produce the signature hash. This should match with the request we will send to the Azure Storage REST API. It is part of the `Authorization` header.
- `key` is the key used to produce the signature hash.
- `Authorization` and `x-ms-date` headers are mandatory.

The signature error messages are quite straightforward.

This code snippet retrieves the metadata of the queue. This contains the custom metadata as well as the estimated queue length.

```powershell
$ErrorActionPreference = "Stop"

$accountname="charlietest"
$key = "primary or secondary key"
$queue="restish"
$verb = "GET"

$rest_api_uri = "https://$accountname.queue.core.windows.net/$($queue)?comp=metadata";
$date=(Get-Date).ToUniversalTime()
$date_as_string=$date.ToString("R")

$signature_message = "$verb`n`n`n`n`n`n`n`n`n`n`n`nx-ms-date:$date_as_string`nx-ms-version:2015-04-05`n/$accountname/$queue`ncomp:metadata"

[byte[]]$encoded_signature_message = ([System.Text.Encoding]::UTF8).GetBytes($signature_message)
$hmacsha256 = New-Object System.Security.Cryptography.HMACSHA256
$hmacsha256.Key = [Convert]::FromBase64String($key)
$signature_hash = [Convert]::ToBase64String($hmacsha256.ComputeHash($encoded_signature_message))
$auth_token = "SharedKey $accountname`:$signature_hash"

$request_headers = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
$request_headers.Add("Authorization", $auth_token)
$request_headers.Add("x-ms-date", $date_as_string)
$request_headers.Add("x-ms-version", "2015-04-05")

$response = (Invoke-WebRequest -URI $rest_api_uri -Method GET -Headers $request_headers -Verbose -UseBasicParsing)

write-host "Response Content: $($response.Content)"
write-host "Response Headers: $($response.Headers | Out-String)"
write-host "Response Status Code: $($response.StatusCode)"
write-host "# Success !!! retrieving metadata >>" $rest_api_uri
```

## Post-conditions

We can see the header call `x-ms-approximate-messages-count` and two more custom metadata headers `x-ms-meta-owner` and `x-ms-meta-when_to_delete`. The actual metadata entries are `owner` and `when_to_delete`.

I got the following output:

```
VERBOSE: GET https://charlietest.queue.core.windows.net/restish?comp=metadata with 0-byte payload
VERBOSE: received -1-byte response of content type
Response Content:
Response Headers:
Key                             Value
---                             -----
Transfer-Encoding               chunked
x-ms-request-id                 d59b2c6e-1003-0031-44d3-c6586b000000
x-ms-version                    2015-04-05
x-ms-approximate-messages-count 10
x-ms-meta-owner                 charlie
x-ms-meta-when_to_delete        today
Cache-Control                   no-cache
Date                            Wed, 28 Mar 2018 20:27:52 GMT
Server                          Windows-Azure-Queue/1.0 Microsoft-HTTPAPI/2.0

Response Status Code: 200
# Success !!! retrieving metadata >> https://charlietest.queue.core.windows.net/restish?comp=metadata
```

There is no Azure Active Directory involvement in calling Storage REST API.

## Bonus: Upload Blob using REST API

```powershell
$ErrorActionPreference = "Stop"

$accountname="charlietest"
$key = "primary or secondary"
$container="principal"
$blok_blob_name="samplefile.log"

$file_path = "C:\\temp\\samplefile.log"
$BlobOperation = "PUT"
$body = (Get-Content -Path $file_path -Raw)
$filelen = $body.Length

$filelen = (Get-ChildItem -File $file_path).Length
$rest_api_uri = "https://$accountname.blob.core.windows.net/$container/$blok_blob_name";
$date=(Get-Date).ToUniversalTime()
$date_as_string=$date.ToString("R");

$signature_message = "$BlobOperation`n`n`n$filelen`n`n`n`n`n`n`n`n`nx-ms-blob-type:BlockBlob`nx-ms-date:$date_as_string`nx-ms-version:2015-04-05`n/$accountname/$container/$blok_blob_name"

[byte[]]$dataBytes = ([System.Text.Encoding]::UTF8).GetBytes($signature_message)
$hmacsha256 = New-Object System.Security.Cryptography.HMACSHA256
$hmacsha256.Key = [Convert]::FromBase64String($key)
$signature_hash = [Convert]::ToBase64String($hmacsha256.ComputeHash($dataBytes))
$auth_token = "SharedKey $accountname`:$signature_hash"

$request_headers = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
$request_headers.Add("Authorization", $auth_token)
$request_headers.Add("x-ms-date", $date_as_string)
$request_headers.Add("x-ms-version", "2015-04-05")
$request_headers.Add("x-ms-blob-type","BlockBlob")

$response = (Invoke-RestMethod -Uri $rest_api_uri -Method put -Headers $request_headers -InFile $file_path);

write-host "# Success !!! uploaded the file >>" $rest_api_uri
```

---

## References

[Authentication for the Azure Storage Services](https://docs.microsoft.com/en-us/rest/api/storageservices/authentication-for-the-azure-storage-services)


[Get Queue Metadata Operation](https://docs.microsoft.com/en-us/rest/api/storageservices/get-queue-metadata)


[Put Blob Operation](https://docs.microsoft.com/en-us/rest/api/storageservices/put-blob)